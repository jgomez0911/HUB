<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal Grade Forecaster (Pro UI)</title>
    <style>
        body {
            margin: 0;
            background-color: #121212;
            color: #eee;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        /* Sidebar Inputs */
        #sidebar {
            width: 340px;
            background-color: #1e1e1e;
            padding: 25px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            border-right: 1px solid #333;
            box-shadow: 2px 0 15px rgba(0,0,0,0.5);
            z-index: 10;
            overflow-y: auto;
        }
        h2 { margin: 0 0 5px 0; color: #4db8ff; }
        /* Mode Switcher */
        .mode-switch {
            background: #252525;
            padding: 5px;
            border-radius: 8px;
            display: flex;
            margin-bottom: 10px;
            border: 1px solid #333;
        }
        .mode-option {
            flex: 1;
            text-align: center;
            padding: 8px;
            cursor: pointer;
            border-radius: 6px;
            font-size: 13px;
            font-weight: bold;
            color: #888;
            transition: 0.2s;
        }
        .mode-option.active {
            background-color: #4db8ff;
            color: #000;
        }
        .input-group {
            background: #252525;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #333;
        }
        label {
            display: block;
            margin-bottom: 5px;
            color: #aaa;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }
        input[type="text"], input[type="number"] {
            width: 100%;
            background: #333;
            border: 1px solid #444;
            color: white;
            padding: 8px;
            border-radius: 4px;
            box-sizing: border-box;
            margin-bottom: 10px;
        }
        .row { display: flex; gap: 10px; }
        .col { flex: 1; }
        button {
            width: 100%;
            padding: 10px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            transition: 0.2s;
        }

        .btn-add { background-color: #4db8ff; color: #000; }
        .btn-add:hover { background-color: #3399cc; }
        
        .btn-remove { background-color: #ff4444; color: white; width: auto; padding: 5px 10px; font-size: 12px;}

        .btn-clear {
            background-color: transparent;
            border: 1px solid #444;
            color: #888;
            font-size: 12px;
            padding: 5px;
            margin-top: 10px;
        }
        .btn-clear:hover { border-color: #ff4444; color: #ff4444; }

        #grade-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
        }

        .grade-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #2a2a2a;
            padding: 10px;
            border-radius: 4px;
            border-left: 3px solid #4db8ff;
            font-size: 14px;
        }

        /* Main Visualization Area */
        #main-area {
            flex-grow: 1;
            position: relative;
            display: flex;
            flex-direction: column;
            background-color: #000;
        }

        #canvas-container {
            flex-grow: 1;
            position: relative;
        }

        canvas { display: block; width: 100%; height: 100%; }

        /* The Slider Control Panel */
        #slider-panel {
            height: 140px;
            background-color: #1a1a1a;
            border-top: 1px solid #333;
            padding: 0 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        input[type=range] {
            -webkit-appearance: none; 
            width: 100%; 
            background: transparent; 
        }
        
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 24px;
            width: 24px;
            border-radius: 50%;
            background: #fff;
            cursor: pointer;
            margin-top: -10px; 
            box-shadow: 0 0 10px rgba(255,255,255,0.5);
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #444;
            border-radius: 2px;
        }
        
        .slider-labels {
            display: flex;
            justify-content: space-between;
            color: #888;
            font-size: 12px;
            margin-top: 10px;
        }

        .sim-score {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            color: #fff;
            margin-bottom: 10px;
        }

        /* --- CUSTOM MODAL STYLES --- */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
            z-index: 100;
            backdrop-filter: blur(2px);
        }

        .modal-box {
            background: #252525;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #444;
            width: 300px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            animation: popIn 0.2s ease-out;
        }

        @keyframes popIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .modal-title {
            color: #fff;
            font-size: 18px;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .modal-text {
            color: #aaa;
            font-size: 14px;
            margin-bottom: 20px;
            line-height: 1.4;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
        }

        .btn-modal-cancel {
            background: #333;
            color: #fff;
        }
        .btn-modal-cancel:hover { background: #444; }

        .btn-modal-confirm {
            background: #4db8ff;
            color: #000;
        }
        .btn-modal-confirm:hover { background: #3399cc; }

/* PHONE MODE (Left/Right Layout with 100dvh fix) */
    @media (min-width: 100px) and (max-width: 500px) {

        /* 1. Sidebar: Left 30% */
        #sidebar {
            width: 35%;
            min-width: 0; /* Allow shrinking below text size */
            min-height: 0;
            max-height: 90%;
            padding: 5px;
            border-right: 1px solid #333;
            /* Remove box-shadow to save space */
            box-shadow: none;
        }

        /* 2. Main Area: Right 70% */
        #main-area {
            width: 65%;
            width: 0; /* Flexbox trick to force shrinking */
            max-height: 90%;
            min-height: 0;
            flex-grow: 1;
            overflow: hidden;
        }

        /* 3. Stack Inputs Vertically */
        #sidebar .row {
            flex-direction: column;
            gap: 2px;
        }

        /* 4. Hide non-essential UI */
        .subtitle, #slider-panel .slider-labels {
            display: none;
        }

        /* 5. Micro-Sizing for Text/Inputs */
        h2 { font-size: 0.8rem; margin-bottom: 5px; text-align: center; }
        label { font-size: 8px; margin-bottom: 0; }
        
        input[type="text"], input[type="number"] {
            font-size: 11px;
            padding: 4px;
            margin-bottom: 4px;
            width: 100%;
        }

        /* 6. Compact List Items */
        .grade-item {
            flex-direction: column;
            padding: 4px;
            font-size: 9px;
            align-items: flex-start;
            border-left-width: 2px;
        }
        
        .btn-remove {
            padding: 1px;
            font-size: 10px;
            width: 100%;
            margin-top: 2px;
        }

        .btn-add, .btn-clear {
            font-size: 10px;
            padding: 5px;
        }

        /* 7. Compact Slider Panel */
        #slider-panel {
            height: 50px;
            padding: 0 5px;
        }
        .sim-score { font-size: 12px; margin-bottom: 2px; }

        /* Mode Switcher Compact */
        .mode-switch { padding: 2px; margin-bottom: 5px; }
        .mode-option { padding: 4px; font-size: 10px; }
    }

    </style>
</head>
<body>

    <div id="customModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title" id="modalTitle">Confirm Action</div>
            <div class="modal-text" id="modalText">Are you sure?</div>
            <div class="modal-actions">
                <button class="btn-modal-cancel" id="modalCancel">Cancel</button>
                <button class="btn-modal-confirm" id="modalConfirm">Confirm</button>
            </div>
        </div>
    </div>

    <div id="sidebar">
        <h2>Grade Forecaster</h2>
        <div style="font-size: 12px; color: #666; margin-bottom: 10px;">Changes save automatically</div>

        <div class="mode-switch">
            <div class="mode-option active" id="modeWeighted" onclick="userSwitchMode('weighted')">Weighted %</div>
            <div class="mode-option" id="modePoints" onclick="userSwitchMode('points')">Total Points</div>
        </div>

        <div class="input-group">
            <label>Add Assignment</label>
            <input type="text" id="catName" placeholder="e.g. Midterm">
            <div class="row">
                <div class="col">
                    <label id="labelA">Score (%)</label>
                    <input type="number" id="inputA" placeholder="95">
                </div>
                <div class="col">
                    <label id="labelB">Weight (%)</label>
                    <input type="number" id="inputB" placeholder="20">
                </div>
            </div>
            <button class="btn-add" id="addBtn">Add Component</button>
        </div>

        <div id="grade-list"></div>

        <div class="input-group" style="margin-top: auto; border-color: #444;">
            <label style="color: #4db8ff;" id="labelFinal">Final Exam Weight (%)</label>
            <input type="number" id="finalInput" value="30">
        </div>

        <button class="btn-clear" onclick="clearAllData()">Reset All Data</button>
    </div>

    <div id="main-area">
        <div id="canvas-container">
            <canvas id="gradeCanvas"></canvas>
        </div>

        <div id="slider-panel">
            <div class="sim-score">Simulated Final: <span id="simVal" style="color:#4db8ff">85</span></div>
            <input type="range" id="examSlider" min="0" max="100" value="85">
            <div class="slider-labels">
                <span id="sliderMin">0</span>
                <span id="sliderMid">50</span>
                <span id="sliderMax">100</span>
            </div>
        </div>
    </div>

<script>
    const canvas = document.getElementById('gradeCanvas');
    const ctx = canvas.getContext('2d');
    
    // UI Refs
    const nameInput = document.getElementById('catName');
    const inputA = document.getElementById('inputA');
    const inputB = document.getElementById('inputB');
    const labelA = document.getElementById('labelA');
    const labelB = document.getElementById('labelB');
    const labelFinal = document.getElementById('labelFinal');
    const finalInput = document.getElementById('finalInput');
    const addBtn = document.getElementById('addBtn');
    const listDiv = document.getElementById('grade-list');
    
    // Slider
    const slider = document.getElementById('examSlider');
    const simValSpan = document.getElementById('simVal');
    const sMin = document.getElementById('sliderMin');
    const sMid = document.getElementById('sliderMid');
    const sMax = document.getElementById('sliderMax');

    // Modal Refs
    const modal = document.getElementById('customModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalText = document.getElementById('modalText');
    const modalYes = document.getElementById('modalConfirm');
    const modalNo = document.getElementById('modalCancel');

    // State
    let mode = 'weighted';
    let components = [];

    // Resize
    function resize() {
        canvas.width = canvas.parentElement.offsetWidth;
        canvas.height = canvas.parentElement.offsetHeight;
        draw();
    }
    window.addEventListener('resize', resize);

    // --- Modal Logic ---
    let pendingCallback = null;

    function showModal(title, text, callback) {
        modalTitle.textContent = title;
        modalText.textContent = text;
        modal.style.display = 'flex';
        pendingCallback = callback;
    }

    modalNo.addEventListener('click', () => {
        modal.style.display = 'none';
        pendingCallback = null;
    });

    modalYes.addEventListener('click', () => {
        if(pendingCallback) pendingCallback();
        modal.style.display = 'none';
        pendingCallback = null;
    });

    // --- Local Storage ---

    function saveData() {
        const data = {
            mode: mode,
            components: components,
            finalVal: finalInput.value
        };
        localStorage.setItem('gradeData', JSON.stringify(data));
    }

    function loadData() {
        const saved = localStorage.getItem('gradeData');
        if (saved) {
            try {
                const data = JSON.parse(saved);
                if (data.finalVal !== undefined) finalInput.value = data.finalVal;
                if (data.components) components = data.components;
                setMode(data.mode || 'weighted', true);
            } catch (e) {
                console.error("Error loading data", e);
                setMode('weighted', false);
            }
        } else {
            setMode('weighted', false);
        }
    }

    function clearAllData() {
        showModal("Reset Data?", "This will delete all saved grades. This cannot be undone.", () => {
            localStorage.removeItem('gradeData');
            components = [];
            finalInput.value = mode === 'weighted' ? "30" : "100";
            renderList();
            saveData();
        });
    }

    // --- Mode Logic ---

    function userSwitchMode(newMode) {
        if (mode !== newMode) {
            if(components.length > 0) {
                showModal("Switch Modes?", "Switching grading modes will clear your current assignments.", () => {
                    setMode(newMode, false);
                });
            } else {
                setMode(newMode, false);
            }
        }
    }

    function setMode(newMode, keepData) {
        mode = newMode;
        
        document.getElementById('modeWeighted').className = mode === 'weighted' ? 'mode-option active' : 'mode-option';
        document.getElementById('modePoints').className = mode === 'points' ? 'mode-option active' : 'mode-option';

        if (mode === 'weighted') {
            labelA.textContent = "Score (%)";
            inputA.placeholder = "95";
            labelB.textContent = "Weight (%)";
            inputB.placeholder = "20";
            labelFinal.textContent = "Final Exam Weight (%)";
            if (!keepData) finalInput.value = "30";
        } else {
            labelA.textContent = "Points Earned";
            inputA.placeholder = "45";
            labelB.textContent = "Max Points";
            inputB.placeholder = "50";
            labelFinal.textContent = "Final Exam Max Points";
            if (!keepData) finalInput.value = "100";
        }

        if (!keepData) components = [];
        renderList();
        saveData();
    }

    // --- Core Math ---

    function calculateGrade(simFinalVal) {
        if (mode === 'weighted') {
            let totalScore = 0;
            let totalWeight = 0;

            components.forEach(c => {
                totalScore += c.valA * c.valB;
                totalWeight += c.valB;
            });

            const fWeight = parseFloat(finalInput.value) || 0;
            totalScore += simFinalVal * fWeight;
            totalWeight += fWeight;

            if (totalWeight === 0) return 0;
            return totalScore / totalWeight;

        } else {
            let totalEarned = 0;
            let totalPossible = 0;

            components.forEach(c => {
                totalEarned += c.valA;
                totalPossible += c.valB;
            });

            const fMax = parseFloat(finalInput.value) || 0;
            totalEarned += simFinalVal; 
            totalPossible += fMax;

            if (totalPossible === 0) return 0;
            return (totalEarned / totalPossible) * 100;
        }
    }

    // --- Rendering ---

    function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const w = canvas.width;
            const h = canvas.height;
            const centerX = w / 2;
            
            // --- SMART SCALING LOGIC ---
            // Check if we are on a narrow screen (Phone Mode)
            const isMobile = w < 500; 

            // Adjust sizes based on screen width
            const tankW = isMobile ? w * 0.6 : 200;  // Mobile: Tank is 60% of width. Desktop: Fixed 200px.
            const tankH = h * 0.6;
            const tankX = centerX - tankW/2;
            const tankY = h * 0.2;
            
            const fontBig = isMobile ? "bold 40px Arial" : "bold 80px Arial";
            const fontHuge = isMobile ? "bold 60px Arial" : "bold 120px Arial";
            const fontSmall = isMobile ? "10px Arial" : "14px Arial";
            // ---------------------------

            let simFinal = parseFloat(slider.value);
            
            if (mode === 'points') {
                const fMax = parseFloat(finalInput.value) || 100;
                slider.max = fMax;
                sMax.innerText = fMax;
                sMid.innerText = (fMax / 2).toFixed(0);
            } else {
                slider.max = 100;
                sMax.innerText = "100";
                sMid.innerText = "50";
            }

            const finalGrade = calculateGrade(simFinal);

            // 1. Draw Grade Lines (Background)
            // We pass 'isMobile' so we can hide the text labels if it's too cramped
            drawGradeLine(90, "A", tankX, tankY, tankW, tankH, isMobile);
            drawGradeLine(80, "B", tankX, tankY, tankW, tankH, isMobile);
            drawGradeLine(70, "C", tankX, tankY, tankW, tankH, isMobile);
            drawGradeLine(60, "D", tankX, tankY, tankW, tankH, isMobile);

            // 2. Draw Tank Border
            ctx.strokeStyle = "#555";
            ctx.lineWidth = isMobile ? 2 : 4; // Thinner lines on mobile
            ctx.strokeRect(tankX, tankY, tankW, tankH);

            // 3. Draw Liquid
            const fillHeight = Math.max(0, Math.min(tankH, (finalGrade / 100) * tankH));
            
            let color = "#ff4444"; 
            if (finalGrade >= 60) color = "#ffae00"; 
            if (finalGrade >= 70) color = "#ffff00"; 
            if (finalGrade >= 80) color = "#4db8ff"; 
            if (finalGrade >= 90) color = "#44ff44"; 

            ctx.fillStyle = color;
            // Adjust liquid margin slightly
            const gap = isMobile ? 1 : 2;
            ctx.fillRect(tankX + gap, tankY + tankH - fillHeight, tankW - (gap*2), fillHeight);

            // 4. Draw Score Text
            ctx.fillStyle = "#fff";
            ctx.font = fontBig; // Uses the dynamic size
            ctx.textAlign = "center";
            // Position text closer to tank on mobile
            ctx.fillText(finalGrade.toFixed(1) + "%", centerX, tankY - (isMobile ? 15 : 30));

            // 5. Draw Background Letter
            let letter = "F";
            if (finalGrade >= 60) letter = "D";
            if (finalGrade >= 70) letter = "C";
            if (finalGrade >= 80) letter = "B";
            if (finalGrade >= 90) letter = "A";

            ctx.font = fontHuge; // Uses the dynamic size
            ctx.globalAlpha = 0.1;
            ctx.fillText(letter, centerX, tankY + tankH / 2 + (isMobile ? 20 : 40));
            ctx.globalAlpha = 1.0;

            // 6. Info Text (Bottom)
            ctx.fillStyle = "#666";
            ctx.font = fontSmall;
            if (mode === 'weighted') {
                let currentWeight = 0;
                components.forEach(c => currentWeight += c.valB);
                currentWeight += parseFloat(finalInput.value) || 0;
                ctx.fillText(`Total Weight: ${currentWeight}%`, centerX, h - (isMobile ? 10 : 20));
            } else {
                let totalPts = 0;
                components.forEach(c => totalPts += c.valB);
                totalPts += parseFloat(finalInput.value) || 0;
                ctx.fillText(`Total Course Points: ${totalPts}`, centerX, h - (isMobile ? 10 : 20));
            }
        }

    // Updated Helper to handle small screens
    function drawGradeLine(score, label, x, y, w, h, isMobile) {
        const yPos = y + h - (score / 100 * h);
        ctx.beginPath();
        
        // On mobile, extend lines slightly less
        const ext = isMobile ? 5 : 20;
        
        ctx.moveTo(x - ext, yPos);
        ctx.lineTo(x + w + ext, yPos);
        ctx.strokeStyle = "#333";
        ctx.lineWidth = isMobile ? 1 : 2;
        ctx.setLineDash([5, 5]);
        ctx.stroke();
        ctx.setLineDash([]);
        
        // Only draw the "90% (A)" labels if we aren't on mobile
        // On narrow screens, these clutter the view
        if (!isMobile) {
            ctx.fillStyle = "#888";
            ctx.font = "bold 14px Arial";
            ctx.textAlign = "right";
            ctx.fillText(score + "% (" + label + ")", x - 25, yPos + 5);
        }
    }
    // --- UI Lists ---

    function renderList() {
        listDiv.innerHTML = "";
        components.forEach((c, index) => {
            const div = document.createElement('div');
            div.className = "grade-item";
            
            let text = "";
            if (mode === 'weighted') {
                text = `Score: ${c.valA}% | W: ${c.valB}%`;
            } else {
                text = `Pts: ${c.valA} / ${c.valB}`;
            }

            div.innerHTML = `
                <div>
                    <div style="font-weight:bold; color:#fff">${c.name}</div>
                    <div style="color:#aaa">${text}</div>
                </div>
                <button class="btn-remove" onclick="removeComponent(${index})">X</button>
            `;
            listDiv.appendChild(div);
        });
        draw();
    }

    function addComponent() {
        const name = nameInput.value || "Assignment";
        const valA = parseFloat(inputA.value);
        const valB = parseFloat(inputB.value);

        if (!isNaN(valA) && !isNaN(valB)) {
            components.push({ name, valA, valB });
            renderList();
            saveData();
            nameInput.value = "";
            inputA.value = "";
            inputB.value = "";
        }
    }

    window.removeComponent = function(index) {
        components.splice(index, 1);
        renderList();
        saveData();
    }

    // Listeners
    addBtn.addEventListener('click', addComponent);
    
    slider.addEventListener('input', (e) => {
        simValSpan.innerText = e.target.value;
        draw();
    });

    finalInput.addEventListener('input', () => {
        draw();
        saveData();
    });

    loadData();
    resize();

</script>
</body>
</html>